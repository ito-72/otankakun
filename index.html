<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å•†å“ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼</title>
</head>
<body>
  <div style="display: flex; align-items: center; gap: 1em;">
    <h1>å•†å“ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼</h1>
    <p id="status-message">ğŸ”„ èª­ã¿è¾¼ã¿ä¸­...</p>
  </div>

  <div>
    <label><input type="checkbox" id="sale-toggle" /> ã‚»ãƒ¼ãƒ«ä¸­</label>
    <select id="item-select">
      <option value="">-- é …ç›®ã‚’é¸æŠ --</option>
    </select>
  </div>

  <!-- è¡¨ç¤ºç”¨ãƒ†ãƒ¼ãƒ–ãƒ« -->
  <table border="1" style="margin-top: 1em; border-collapse: collapse;">
    <thead>
      <tr>
        <th>é …ç›®</th>
        <th>å†…å®¹</th>
        <th>å˜ä½</th>
        <th>å€‹æ•°</th>
        <th>ç¨æŠœã</th>
        <th>ç¨è¾¼ã¿</th>
        <th>å˜ä¾¡</th>
        <th>å˜ä¾¡ã®å˜ä½</th>
        <th>ãŠåº—</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td id="item-name">--</td>
        <td id="content">--</td>
        <td id="unit">--</td>
        <td id="count">--</td>
        <td id="price-before-tax">--</td>
        <td id="price-taxed">--</td>
        <td id="unit-price">--</td>
        <td id="unit-of-unit-price">--</td>
        <td id="store">--</td>
      </tr>
    </tbody>
  </table>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      fetchAndPopulateItems();
    });

    let allItems = [];

    async function fetchAndPopulateItems() {
      const statusMessage = document.getElementById("status-message");

      try {
        const response = await fetch("/api/fetchData", { method: "POST" });
        const data = await response.json();
        allItems = data;

        console.log("å–å¾—ãƒ‡ãƒ¼ã‚¿:", data);

        populateItemSelect();

        statusMessage.style.display = "none";

        // ã‚»ãƒ¬ã‚¯ãƒˆå¤‰æ›´ or ã‚»ãƒ¼ãƒ«åˆ‡æ›¿ã§è¡¨ç¤ºæ›´æ–°
        document.getElementById("item-select").addEventListener("change", updateTableDisplay);
        document.getElementById("sale-toggle").addEventListener("change", updateTableDisplay);
      } catch (error) {
        console.error("ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
        statusMessage.textContent = "âš ï¸ ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ";
      }
    }

    function populateItemSelect() {
      const displayItemSelect = document.getElementById("item-select");
      const uniqueItems = [...new Set(allItems.map(item => item.itemName).filter(Boolean))];
      displayItemSelect.innerHTML = '<option value="">-- é …ç›®ã‚’é¸æŠ --</option>';
      uniqueItems.forEach(name => {
        const option = document.createElement("option");
        option.value = name;
        option.textContent = name;
        displayItemSelect.appendChild(option);
      });
    }

   function updateTableDisplay() {
  const selectedItem = document.getElementById("item-select").value;
  const saleOnly = document.getElementById("sale-toggle").checked;

  // ã€Œã‚»ãƒ¼ãƒ«ã®æœ‰ç„¡ã€ã¨ã€Œé¸æŠã•ã‚ŒãŸé …ç›®åã€ã®ä¸¡æ–¹ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
  const filtered = allItems.filter(item => {
    const nameMatches = item.itemName === selectedItem;
    const saleMatches = saleOnly ? item.sale === true : item.sale !== true;
    return nameMatches && saleMatches;
  });

  const latest = filtered[filtered.length - 1];

  const fieldMap = {
    "item-name": "itemName",
    "content": "content",
    "unit": "unit",
    "count": "count",
    "price-before-tax": "priceBeforeTax",
    "price-taxed": "priceTaxed",
    "unit-price": "unitPrice",
    "unit-of-unit-price": "unitOfUnitPrice",
    "store": "store",
  };

  if (latest) {
    for (const [id, key] of Object.entries(fieldMap)) {
      document.getElementById(id).textContent = latest[key] ?? "--";
    }
  } else {
    for (const id of Object.keys(fieldMap)) {
      document.getElementById(id).textContent = "--";
    }
  }
}



  </script>


</body>
</html>
