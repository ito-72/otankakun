<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å•†å“ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼</title>
  <link rel="stylesheet" href="style.css" />
</head>


<body>
  <div class="container">

    <!-- è¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <section class="display-section">
      <div style="display: flex; align-items: center; gap: 1em;">
        <h1>å•†å“ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼</h1>
        <p id="status-message">ğŸ”„ èª­ã¿è¾¼ã¿ä¸­...</p>
      </div>

      <div>
        <label><input type="checkbox" id="sale-toggle" /> ã‚»ãƒ¼ãƒ«ä¸­</label>
        <select id="item-select">
          <option value="">-- é …ç›®ã‚’é¸æŠ --</option>
        </select>
      </div>

      <!-- è¡¨ç¤ºç”¨ãƒ†ãƒ¼ãƒ–ãƒ« -->
      <table border="1" style="margin-top: 1em; border-collapse: collapse;">
        <thead>
          <tr>
            <th>é …ç›®</th>
            <th>å†…å®¹é‡</th>
            <th>å˜ä½</th>
            <th>å€‹æ•°ï¼ˆå†…å®¹é‡ã®ã‚‚ã®ãŒã„ãã¤ã‚ã‚‹ã‹ï¼‰</th>
            <th>ç¨æŠœã</th>
            <th>ç¨è¾¼ã¿</th>
            <th>å˜ä¾¡ï¼ˆç¨è¾¼ã¿ï¼‰</th>
            <th>å˜ä¾¡ã®å˜ä½</th>
            <th>ãŠåº—</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td id="item-name">--</td>
            <td id="content">--</td>
            <td id="unit">--</td>
            <td id="count">--</td>
            <td id="price-before-tax">--</td>
            <td id="price-taxed">--</td>
            <td id="unit-price">--</td>
            <td id="unit-of-unit-price">--</td>
            <td id="store">--</td>
          </tr>
        </tbody>
      </table>
    </section>

    <!-- å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <section class="input-section">

   <!-- ğŸŸ£ å…¥åŠ›æ¬„ï¼ˆãƒ©ãƒ™ãƒ«ï¼‹å…¥åŠ›ï¼‰ -->
<div class="form-row">
  <label for="input-content">å†…å®¹é‡</label>
  <input type="number" id="input-content" />
</div>

<div class="form-row">
  <label for="input-count">å€‹æ•°</label>
  <input type="number" id="input-count" />
</div>

<div class="form-row">
  <label for="input-price">é‡‘é¡</label>
  <input type="number" id="input-price" />
</div>

<div class="form-row">
  <label>ç¨æŠœ / ç¨è¾¼</label>
  <div class="radio-group">
    <label><input type="radio" name="tax-mode" value="before" checked /> ç¨æŠœ</label>
    <label><input type="radio" name="tax-mode" value="after" /> ç¨è¾¼</label>
  </div>
</div>

<div class="form-row">
  <label for="calculated-unit-price">å˜ä¾¡</label>
  <input type="text" id="calculated-unit-price" readonly />
</div>



      <button id="calculate-btn" style="margin-top: 1em;">ğŸ§® å˜ä¾¡ã‚’è¨ˆç®—ï¼</button>

      <table border="1" style="margin-top: 1em; border-collapse: collapse;">
        <thead>
          <tr>
            <th>ã‚»ãƒ¼ãƒ«ä¸­</th>
            <th>é …ç›®</th>
            <th>å˜ä½</th>
            <th>ãŠåº—</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><input type="checkbox" id="input-sale" /></td>
            <td>
              <select id="input-item-select">
                <option value="">-- é …ç›®ã‚’é¸æŠ --</option>
                <option value="__new__">ï¼‹ æ–°è¦è¿½åŠ </option>
              </select>
              <div id="new-item-wrapper" style="display:none;">
                <input type="text" id="new-item-name" placeholder="æ–°ã—ã„é …ç›®å" />
              </div>
            </td>
            <td><input type="text" id="input-unit" /></td>
            <td>
              <select id="input-store-select">
                <option value="">-- ãŠåº—ã‚’é¸æŠ --</option>
                <option value="__new__">ï¼‹ æ–°è¦è¿½åŠ </option>
              </select>
              <div id="new-store-wrapper" style="display:none;">
                <input type="text" id="new-store-name" placeholder="æ–°ã—ã„ãŠåº—å" />
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <button id="register-btn" style="margin-top: 1em;">ğŸ“ ç™»éŒ²</button>
      <p id="register-status" style="margin-top: 0.5em; color: green;"></p>
    </section>

  </div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    fetchAndPopulateItems();
  });

  let allItems = [];

  async function fetchAndPopulateItems() {
    const statusMessage = document.getElementById("status-message");

    try {
      const response = await fetch("/api/fetchData", { method: "POST" });
      const data = await response.json();
      allItems = data;

      console.log("å–å¾—ãƒ‡ãƒ¼ã‚¿:", data);

      populateItemSelect();
      populateInputSelects(); // â† è¿½åŠ 

      statusMessage.style.display = "none";

      document.getElementById("item-select").addEventListener("change", updateTableDisplay);
      document.getElementById("sale-toggle").addEventListener("change", updateTableDisplay);
    } catch (error) {
      console.error("ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
      statusMessage.textContent = "âš ï¸ ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ";
    }
  }

  function populateItemSelect() {
    const displayItemSelect = document.getElementById("item-select");
    const uniqueItems = [...new Set(allItems.map(item => item.itemName).filter(Boolean))];
    displayItemSelect.innerHTML = '<option value="">-- é …ç›®ã‚’é¸æŠ --</option>';
    uniqueItems.forEach(name => {
      const option = document.createElement("option");
      option.value = name;
      option.textContent = name;
      displayItemSelect.appendChild(option);
    });
  }

  function populateInputSelects() {
    // é …ç›®ã‚»ãƒ¬ã‚¯ãƒˆ
    const inputItemSelect = document.getElementById("input-item-select");
    const uniqueItemNames = [...new Set(allItems.map(item => item.itemName).filter(Boolean))];
    inputItemSelect.innerHTML = '<option value="">-- é …ç›®ã‚’é¸æŠ --</option>';
    uniqueItemNames.forEach(name => {
      const option = document.createElement("option");
      option.value = name;
      option.textContent = name;
      inputItemSelect.appendChild(option);
    });
    const newOption = document.createElement("option");
    newOption.value = "__new__";
    newOption.textContent = "ï¼‹ æ–°è¦è¿½åŠ ";
    inputItemSelect.appendChild(newOption);

    // ãŠåº—ã‚»ãƒ¬ã‚¯ãƒˆ
    const inputStoreSelect = document.getElementById("input-store-select");
    const uniqueStores = [...new Set(allItems.map(item => item.store).filter(Boolean))];
    inputStoreSelect.innerHTML = '<option value="">-- ãŠåº—ã‚’é¸æŠ --</option>';
    uniqueStores.forEach(store => {
      const option = document.createElement("option");
      option.value = store;
      option.textContent = store;
      inputStoreSelect.appendChild(option);
    });
    const newStoreOption = document.createElement("option");
    newStoreOption.value = "__new__";
    newStoreOption.textContent = "ï¼‹ æ–°è¦è¿½åŠ ";
    inputStoreSelect.appendChild(newStoreOption);
  }

  function updateTableDisplay() {
    const selectedItem = document.getElementById("item-select").value;
    const saleOnly = document.getElementById("sale-toggle").checked;

    const filtered = allItems.filter(item => {
      const nameMatches = item.itemName === selectedItem;
      const saleMatches = saleOnly ? item.sale === true : item.sale !== true;
      return nameMatches && saleMatches;
    });

    const latest = filtered[filtered.length - 1];

    const fieldMap = {
      "item-name": "itemName",
      "content": "content",
      "unit": "unit",
      "count": "count",
      "price-before-tax": "priceBeforeTax",
      "price-taxed": "priceTaxed",
      "unit-price": "unitPrice",
      "unit-of-unit-price": "unitOfUnitPrice",
      "store": "store",
    };

    if (latest) {
      for (const [id, key] of Object.entries(fieldMap)) {
        document.getElementById(id).textContent = latest[key] ?? "--";
      }
    } else {
      for (const id of Object.keys(fieldMap)) {
        document.getElementById(id).textContent = "--";
      }
    }
  }

  // å…¥åŠ›å–å¾—
  const inputContent = document.getElementById("input-content");
  const inputCount = document.getElementById("input-count");
  const inputPrice = document.getElementById("input-price");
  const unitPriceField = document.getElementById("calculated-unit-price");

  const inputItemSelect = document.getElementById("input-item-select");
  const newItemWrapper = document.getElementById("new-item-wrapper");
  const inputStoreSelect = document.getElementById("input-store-select");
  const newStoreWrapper = document.getElementById("new-store-wrapper");

  const inputUnit = document.getElementById("input-unit"); // âœ… â† è¿½åŠ ã“ã“ï¼

  // ç¨æŠœâ†’ç¨è¾¼ï¼ˆ10%ï¼‰
  function calculateTaxIncluded(price, isTaxBefore) {
    return isTaxBefore ? Math.round(price * 1.1) : price;
  }

  // å˜ä¾¡è¨ˆç®—ï¼ˆãƒœã‚¿ãƒ³ç”¨ï¼‰
  function updateUnitPriceFromButton() {
    const content = parseFloat(inputContent.value);
    const count = parseFloat(inputCount.value);
    const price = parseFloat(inputPrice.value);
    const taxMode = document.querySelector('input[name="tax-mode"]:checked').value;

    if (!isNaN(content) && !isNaN(count) && !isNaN(price) && content > 0 && count > 0) {
      const totalAmount = count * content;
      const taxedPrice = calculateTaxIncluded(price, taxMode === "before");
      const unitPrice = taxedPrice / totalAmount;
      unitPriceField.value = unitPrice.toFixed(2);
    } else {
      unitPriceField.value = "";
    }
  }

  // ğŸ§®ãƒœã‚¿ãƒ³ã§è¨ˆç®—
  document.getElementById("calculate-btn").addEventListener("click", updateUnitPriceFromButton);

  // å…¥åŠ›å¤‰åŒ–ã§ã‚‚è‡ªå‹•è¨ˆç®—
  function triggerCalculateButton() {
    document.getElementById("calculate-btn").click();
  }

  inputContent.addEventListener("input", triggerCalculateButton);
  inputCount.addEventListener("input", triggerCalculateButton);
  inputPrice.addEventListener("input", triggerCalculateButton);
  document.querySelectorAll('input[name="tax-mode"]').forEach(radio => {
    radio.addEventListener("change", triggerCalculateButton);
  });

  // æ–°è¦é …ç›®ãƒ»ãŠåº—ã®æ¬„ã‚’åˆ‡ã‚Šæ›¿ãˆï¼‹å˜ä½è‡ªå‹•åæ˜ 
  inputItemSelect.addEventListener("change", () => {
    newItemWrapper.style.display = inputItemSelect.value === "__new__" ? "block" : "none";

    const selected = inputItemSelect.value;
    if (selected === "__new__") {
      inputUnit.value = "";
      inputUnit.readOnly = false;
    } else {
      const matchedItem = allItems.find(item => item.itemName === selected);
      if (matchedItem) {
        inputUnit.value = matchedItem.unit || "";
        inputUnit.readOnly = true;
      } else {
        inputUnit.value = "";
        inputUnit.readOnly = false;
      }
    }
  });

  inputStoreSelect.addEventListener("change", () => {
    newStoreWrapper.style.display = inputStoreSelect.value === "__new__" ? "block" : "none";
  });



//ç™»éŒ²ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
document.getElementById("register-btn").addEventListener("click", async () => {
  const itemName = inputItemSelect.value === "__new__"
    ? document.getElementById("new-item-name").value.trim()
    : inputItemSelect.value;

  const storeName = inputStoreSelect.value === "__new__"
    ? document.getElementById("new-store-name").value.trim()
    : inputStoreSelect.value;

  const payload = {
    mode: "recordItem",
    itemName,
    content: inputContent.value,
    unit: inputUnit.value,
    count: inputCount.value,
    priceBeforeTax: inputPrice.value,
    priceTaxed: calculateTaxIncluded(parseFloat(inputPrice.value), document.querySelector('input[name="tax-mode"]:checked').value === "before"),
    unitPrice: unitPriceField.value,
    unitOfUnitPrice: inputUnit.value,
    store: storeName,
    sale: document.getElementById("input-sale").checked
  };

  try {
    const response = await fetch("/api/recordItem", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const result = await response.json();

    if (result.success) {
      document.getElementById("register-status").textContent = "âœ… ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼";
    } else {
      document.getElementById("register-status").textContent = "âš ï¸ ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
    }
  } catch (error) {
    console.error("ç™»éŒ²ã‚¨ãƒ©ãƒ¼:", error);
    document.getElementById("register-status").textContent = "âš ï¸ é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
  }
});



</script>


</body>
</html>
