<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>商品セレクター</title>
</head>
<body>
  <div style="display: flex; align-items: center; gap: 1em;">
    <h1>商品セレクター</h1>
    <p id="status-message">🔄 読み込み中...</p>
  </div>

  <div>
    <label><input type="checkbox" id="sale-toggle" /> セール中</label>
    <select id="item-select">
      <option value="">-- 項目を選択 --</option>
    </select>
  </div>

  <!-- 表示用テーブル -->
  <table border="1" style="margin-top: 1em; border-collapse: collapse;">
    <thead>
      <tr>
        <th>項目</th>
        <th>内容量</th>
        <th>単位</th>
        <th>個数（内容量のものがいくつあるか）</th>
        <th>税抜き</th>
        <th>税込み</th>
        <th>単価（税込み）</th>
        <th>単価の単位</th>
        <th>お店</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td id="item-name">--</td>
        <td id="content">--</td>
        <td id="unit">--</td>
        <td id="count">--</td>
        <td id="price-before-tax">--</td>
        <td id="price-taxed">--</td>
        <td id="unit-price">--</td>
        <td id="unit-of-unit-price">--</td>
        <td id="store">--</td>
      </tr>
    </tbody>
  </table>


<!-- 入力テーブル -->
<table border="1" style="margin-top: 2em; border-collapse: collapse;">
  <thead>
    <tr>
      <th>内容量</th>
      <th>個数</th>
      <th>金額</th>
      <th>税抜 / 税込</th>
      <th>単価（税込）</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><input type="number" id="input-content" /></td>
      <td><input type="number" id="input-count" /></td>
      <td><input type="number" id="input-price" /></td>
      <td>
        <label><input type="radio" name="tax-mode" value="before" checked /> 税抜</label>
        <label><input type="radio" name="tax-mode" value="after" /> 税込</label>
      </td>
      <td><input type="text" id="calculated-unit-price" readonly /></td>
    </tr>
  </tbody>
</table>


<table border="1" style="margin-top: 1em; border-collapse: collapse;">
  <thead>
    <tr>
      <th>セール中</th>
      <th>項目</th>
      <th>単位</th>
      <th>お店</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><input type="checkbox" id="input-sale" /></td>
      <td>
        <select id="input-item-select">
          <option value="">-- 項目を選択 --</option>
          <option value="__new__">＋ 新規追加</option>
        </select>
        <div id="new-item-wrapper" style="display:none;">
          <input type="text" id="new-item-name" placeholder="新しい項目名" />
        </div>
      </td>
      <td><input type="text" id="input-unit" /></td>
      <td>
        <select id="input-store-select">
          <option value="">-- お店を選択 --</option>
          <option value="__new__">＋ 新規追加</option>
        </select>
        <div id="new-store-wrapper" style="display:none;">
          <input type="text" id="new-store-name" placeholder="新しいお店名" />
        </div>
      </td>
    </tr>
  </tbody>
</table>



<script>
  document.addEventListener("DOMContentLoaded", () => {
    fetchAndPopulateItems();
  });

  let allItems = [];

  async function fetchAndPopulateItems() {
    const statusMessage = document.getElementById("status-message");

    try {
      const response = await fetch("/api/fetchData", { method: "POST" });
      const data = await response.json();
      allItems = data;

      console.log("取得データ:", data);

      populateItemSelect();
      populateInputSelects(); // ← 追加

      statusMessage.style.display = "none";

      document.getElementById("item-select").addEventListener("change", updateTableDisplay);
      document.getElementById("sale-toggle").addEventListener("change", updateTableDisplay);
    } catch (error) {
      console.error("データ取得エラー:", error);
      statusMessage.textContent = "⚠️ データ取得に失敗しました";
    }
  }

  function populateItemSelect() {
    const displayItemSelect = document.getElementById("item-select");
    const uniqueItems = [...new Set(allItems.map(item => item.itemName).filter(Boolean))];
    displayItemSelect.innerHTML = '<option value="">-- 項目を選択 --</option>';
    uniqueItems.forEach(name => {
      const option = document.createElement("option");
      option.value = name;
      option.textContent = name;
      displayItemSelect.appendChild(option);
    });
  }

  function populateInputSelects() {
    // 項目セレクト
    const inputItemSelect = document.getElementById("input-item-select");
    const uniqueItemNames = [...new Set(allItems.map(item => item.itemName).filter(Boolean))];
    inputItemSelect.innerHTML = '<option value="">-- 項目を選択 --</option>';
    uniqueItemNames.forEach(name => {
      const option = document.createElement("option");
      option.value = name;
      option.textContent = name;
      inputItemSelect.appendChild(option);
    });
    const newOption = document.createElement("option");
    newOption.value = "__new__";
    newOption.textContent = "＋ 新規追加";
    inputItemSelect.appendChild(newOption);

    // お店セレクト
    const inputStoreSelect = document.getElementById("input-store-select");
    const uniqueStores = [...new Set(allItems.map(item => item.store).filter(Boolean))];
    inputStoreSelect.innerHTML = '<option value="">-- お店を選択 --</option>';
    uniqueStores.forEach(store => {
      const option = document.createElement("option");
      option.value = store;
      option.textContent = store;
      inputStoreSelect.appendChild(option);
    });
    const newStoreOption = document.createElement("option");
    newStoreOption.value = "__new__";
    newStoreOption.textContent = "＋ 新規追加";
    inputStoreSelect.appendChild(newStoreOption);
  }

  function updateTableDisplay() {
    const selectedItem = document.getElementById("item-select").value;
    const saleOnly = document.getElementById("sale-toggle").checked;

    const filtered = allItems.filter(item => {
      const nameMatches = item.itemName === selectedItem;
      const saleMatches = saleOnly ? item.sale === true : item.sale !== true;
      return nameMatches && saleMatches;
    });

    const latest = filtered[filtered.length - 1];

    const fieldMap = {
      "item-name": "itemName",
      "content": "content",
      "unit": "unit",
      "count": "count",
      "price-before-tax": "priceBeforeTax",
      "price-taxed": "priceTaxed",
      "unit-price": "unitPrice",
      "unit-of-unit-price": "unitOfUnitPrice",
      "store": "store",
    };

    if (latest) {
      for (const [id, key] of Object.entries(fieldMap)) {
        document.getElementById(id).textContent = latest[key] ?? "--";
      }
    } else {
      for (const id of Object.keys(fieldMap)) {
        document.getElementById(id).textContent = "--";
      }
    }
  }

  // 入力取得
  const inputContent = document.getElementById("input-content");
  const inputCount = document.getElementById("input-count");
  const inputPrice = document.getElementById("input-price");
  const unitPriceField = document.getElementById("calculated-unit-price");

  const inputItemSelect = document.getElementById("input-item-select");
  const newItemWrapper = document.getElementById("new-item-wrapper");
  const inputStoreSelect = document.getElementById("input-store-select");
  const newStoreWrapper = document.getElementById("new-store-wrapper");

  const inputUnit = document.getElementById("input-unit"); // ✅ ← 追加ここ！

  // 税抜→税込（10%）
  function calculateTaxIncluded(price, isTaxBefore) {
    return isTaxBefore ? Math.round(price * 1.1) : price;
  }

  // 単価計算（ボタン用）
  function updateUnitPriceFromButton() {
    const content = parseFloat(inputContent.value);
    const count = parseFloat(inputCount.value);
    const price = parseFloat(inputPrice.value);
    const taxMode = document.querySelector('input[name="tax-mode"]:checked').value;

    if (!isNaN(content) && !isNaN(count) && !isNaN(price) && content > 0 && count > 0) {
      const totalAmount = count * content;
      const taxedPrice = calculateTaxIncluded(price, taxMode === "before");
      const unitPrice = taxedPrice / totalAmount;
      unitPriceField.value = unitPrice.toFixed(2);
    } else {
      unitPriceField.value = "";
    }
  }

  // 🧮ボタンで計算
  document.getElementById("calculate-btn").addEventListener("click", updateUnitPriceFromButton);

  // 入力変化でも自動計算
  function triggerCalculateButton() {
    document.getElementById("calculate-btn").click();
  }

  inputContent.addEventListener("input", triggerCalculateButton);
  inputCount.addEventListener("input", triggerCalculateButton);
  inputPrice.addEventListener("input", triggerCalculateButton);
  document.querySelectorAll('input[name="tax-mode"]').forEach(radio => {
    radio.addEventListener("change", triggerCalculateButton);
  });

  // 新規項目・お店の欄を切り替え＋単位自動反映
  inputItemSelect.addEventListener("change", () => {
    newItemWrapper.style.display = inputItemSelect.value === "__new__" ? "block" : "none";

    const selected = inputItemSelect.value;
    if (selected === "__new__") {
      inputUnit.value = "";
      inputUnit.readOnly = false;
    } else {
      const matchedItem = allItems.find(item => item.itemName === selected);
      if (matchedItem) {
        inputUnit.value = matchedItem.unit || "";
        inputUnit.readOnly = true;
      } else {
        inputUnit.value = "";
        inputUnit.readOnly = false;
      }
    }
  });

  inputStoreSelect.addEventListener("change", () => {
    newStoreWrapper.style.display = inputStoreSelect.value === "__new__" ? "block" : "none";
  });
</script>



</body>
</html>
